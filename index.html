<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portail Organisation administrative — République du Congo</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{
      --text:#eef5ff;
      --muted:rgba(238,245,255,.72);
      --line:rgba(255,255,255,.10);
      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#ef4444;
      --radius:16px;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --bgA: rgba(11,18,32,.88);
      --panelBg: rgba(255,255,255,.03);
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(22,163,74,.25), transparent 55%),
                  radial-gradient(900px 700px at 80% 10%, rgba(245,158,11,.22), transparent 55%),
                  radial-gradient(900px 700px at 40% 90%, rgba(239,68,68,.18), transparent 55%),
                  linear-gradient(120deg, #071023, #0b1220);
      color:var(--text);
      overflow: hidden;
    }

    header{
      position: sticky;
      top:0;
      z-index: 1000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding: 12px 16px;
      border-bottom:1px solid var(--line);
      background: var(--bgA);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }

    .logoWrap{
      width:52px;
      height:52px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }

    .logoWrap img{
      max-height: 44px;
      max-width: 44px;
      width:auto;
      height:auto;
      display:block;
    }

    .brandText{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }

    .institution{
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .4px;
      text-transform: uppercase;
      color: rgba(238,245,255,.88);
    }

    .title{
      font-size: 15px;
      font-weight: 800;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subtitle{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .statusPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }

    .dot{
      width:9px; height:9px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 4px rgba(245,158,11,.15);
    }
    .dot.ok{ background: var(--green); box-shadow: 0 0 0 4px rgba(22,163,74,.18); }
    .dot.bad{ background: var(--red); box-shadow: 0 0 0 4px rgba(239,68,68,.18); }

    .wrap{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      padding: 14px;
      height: calc(100vh - 78px);
      min-height: 0;
    }

    aside{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panelBg);
      box-shadow: var(--shadow);
      padding: 12px;
      overflow:auto;
      min-height: 0;
    }

    .mapwrap{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panelBg);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .maphead{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex: 0 0 auto;
    }

    .badgeRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }

    .miniBadge{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(238,245,255,.9);
    }

    .mapBody{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .mapInner{
      flex: 0 0 auto;
      height: calc(100vh - 78px - 14px - 14px - 52px - 24px);
      min-height: 320px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(0,0,0,.10);
    }

    #map{
      width:100%;
      height:100%;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.14);
      padding: 12px;
      margin-bottom: 12px;
    }

    .cardTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight: 800;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .label{
      display:block;
      font-size: 12px;
      color: rgba(238,245,255,.82);
      margin-bottom: 6px;
    }

    select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }

    .check{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      margin-bottom: 8px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      text-decoration:none;
      color: var(--text);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      margin-top: 8px;
    }

    .dl{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 8px;
    }
    .dlItem{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
    }
    .dlTitle{
      font-weight:800;
      font-size:13px;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dlLinks{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(238,245,255,.9);
    }
    .tag.admin{ border-color: rgba(22,163,74,.35); }
    .tag.points{ border-color: rgba(245,158,11,.35); }
    .tag.routes{ border-color: rgba(239,68,68,.35); }

    .leaflet-popup-content-wrapper{ border-radius: 14px; }

    .lbl{
      background: rgba(11,18,32,.88);
      color: #eef5ff;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 4px 8px;
      font-weight: 800;
      font-size: 11px;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      white-space: nowrap;
    }
    .leaflet-tooltip.lbl::before{
      border-top-color: rgba(11,18,32,.88);
    }

    .mobileMenuBtn{
      display:none;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
    }

    .overlay{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 1400;
    }
    .panelMobile{ display:none; }

    #downloadsMobileSlot{ display:none; }
    #mobileControlsSlot{ display:none; }

    @media (max-width: 900px){
      body{ overflow: auto; }
      .wrap{
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 12px;
        height: auto;
      }
      aside{ display:none; }
      .mapwrap{ border-radius: var(--radius); }
      .mapBody{ padding: 12px; }
      .mapInner{
        height: 62vh;
        min-height: 360px;
      }

      #mobileControlsSlot{ display:block; }
      #downloadsMobileSlot{ display:block; }

      .mobileMenuBtn{ display:none !important; }
      .overlay{ display:none !important; }
      .panelMobile{ display:none !important; }
    }

    @media (max-width: 520px){
      header{ padding: 10px 12px; }
      .logoWrap{ width:44px; height:44px; border-radius: 12px; }
      .logoWrap img{ max-width: 36px; max-height: 36px; }
      .title{ font-size: 14px; white-space: normal; }
      .subtitle{ display:none; }
    }

    .docBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="logoWrap" title="Institut Géographique National">
        <img src="assets/ign_logo.png" alt="IGN">
      </div>
      <div class="brandText">
        <div class="institution">Institut Géographique National</div>
        <div class="title">Portail Organisation Administrative — République du Congo</div>
        <div class="subtitle">Visualisation & téléchargement : limites administratives, chefs-lieux et réseau routier structurant</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      <button class="mobileMenuBtn" id="openPanelBtn" type="button" aria-label="Ouvrir le menu">
        Menu
      </button>

      <div class="statusPill" id="statusPill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Chargement…</span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <aside id="desktopAside">
      <div class="card">
        <div class="cardTitle">Filtrer sur</div>
        <label class="label">Jeu de données affiché</label>
        <select id="level">
          <option value="all">Toutes les couches visibles</option>
          <!-- ✅ ordre demandé -->
          <option value="Chef_lieu_departement">Chefs-lieux de départements</option>
          <option value="Chef_lieu_district">Chefs-lieux de districts</option>
          <option value="Reseau_routier_structurant">Réseau routier structurant</option>
          <option value="Limites_departements_congo">Limites des départements</option>
        </select>
        <div class="hint">Astuce : pour afficher/masquer, utilise aussi les cases à cocher.</div>
      </div>

      <div class="card" id="layersCard">
        <div class="cardTitle">Couches</div>
        <!-- ✅ ordre demandé -->
        <label class="check"><input type="checkbox" id="t_cld" checked> <span>Chefs-lieux de départements</span></label>
        <label class="check"><input type="checkbox" id="t_cldist" checked> <span>Chefs-lieux de districts</span></label>
        <label class="check"><input type="checkbox" id="t_routes"> <span>Réseau routier structurant</span></label>
        <label class="check"><input type="checkbox" id="t_dep" checked> <span>Limites des départements</span></label>
      </div>

      <div class="card" id="downloads">
        <div class="cardTitle">Téléchargements</div>
        <div class="hint">Formats : SHP (ZIP) pour SIG • GeoJSON pour web • Metadata (txt).</div>

        <div class="dl">
          <div class="dlItem">
            <div class="dlTitle"><span class="tag admin">ADMIN</span> Limites des départements</div>
            <div class="dlLinks">
              <a class="btn" href="data/shp/Limites_departements_congo/Limites_departements_congo.zip">SHP (ZIP)</a>
              <a class="btn" href="data/geojson/Limites_departements_congo/limites_departements_congo.geojson">GeoJSON</a>
              <a class="btn" href="metadata/Limites_departements_congo/metadata.txt">Metadata</a>
            </div>
          </div>

          <div class="dlItem">
            <div class="dlTitle"><span class="tag points">POINTS</span> Chefs-lieux de départements</div>
            <div class="dlLinks">
              <a class="btn" href="data/shp/Chef_lieu_departement/Chef_lieu_departement.zip">SHP (ZIP)</a>
              <a class="btn" href="data/geojson/Chef_lieu_departement/chef_lieu_departement.geojson">GeoJSON</a>
              <a class="btn" href="metadata/Chef_lieu_departement/metadata.txt">Metadata</a>
            </div>
          </div>

          <div class="dlItem">
            <div class="dlTitle"><span class="tag points">POINTS</span> Chefs-lieux de districts</div>
            <div class="dlLinks">
              <a class="btn" href="data/shp/Chef_lieu_district/Chef_lieu_district.zip">SHP (ZIP)</a>
              <a class="btn" href="data/geojson/Chef_lieu_district/chef_lieu_district.geojson">GeoJSON</a>
              <a class="btn" href="metadata/Chef_lieu_district/metadata.txt">Metadata</a>
            </div>
          </div>

          <div class="dlItem">
            <div class="dlTitle"><span class="tag routes">ROUTES</span> Réseau routier structurant</div>
            <div class="dlLinks">
              <a class="btn" href="data/shp/Reseau_routier_structurant/Reseau_routier_structurant.zip">SHP (ZIP)</a>
              <a class="btn" href="data/geojson/Reseau_routier_structurant/reseau_routier_structurant.geojson">GeoJSON</a>
              <a class="btn" href="metadata/Reseau_routier_structurant/metadata.txt">Metadata</a>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <section class="mapwrap">
      <div class="maphead">
        <div class="badgeRow">
          <span class="miniBadge">Fond : OpenStreetMap</span>
          <span class="miniBadge">Portail : GitHub Pages</span>
        </div>
        <span class="miniBadge">© IGN / Open Data</span>
      </div>

      <div class="mapBody">
        <div id="mobileControlsSlot"></div>

        <div class="mapInner">
          <div id="map"></div>
        </div>

        <div class="card" id="docsPanel">
          <div class="cardTitle">Documentation &amp; Cartes</div>
          <div class="docBtns">
            <!-- ✅ SEULE MODIF : liens absolus + ouverture nouvel onglet -->
            <a class="btn"
               href="https://nicy-bazebi.github.io/congo-open-data-geospatial/docs/presentation_officielle.pdf"
               target="_blank" rel="noopener">
              Documentation officielle
            </a>
            <a class="btn"
               href="https://nicy-bazebi.github.io/congo-open-data-geospatial/docs/carte_A4.pdf"
               target="_blank" rel="noopener">
              Carte officielle en A4
            </a>
          </div>
          <div class="hint">
            Pour toute information complémentaire, notamment pour l’impression de la carte au format A0 ou pour toute demande relative aux cartes administratives des 15 départements, veuillez vous rendre à l’Institut Géographique National (IGN), situé Avenue de l’Union Africaine, place du marché Total, en face de l’établissement Guénin
          </div>
        </div>
      </div>
    </section>

    <div id="downloadsMobileSlot"></div>
  </div>

  <div class="overlay" id="overlay"></div>
  <aside class="panelMobile" id="panelMobile" aria-hidden="true"></aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ✅ ordre demandé (utilisé pour le chargement + l’interface si tu la relies ensuite) */
    const DATASETS = [
      {
        key: "Chef_lieu_departement",
        label: "Chefs-lieux de départements",
        geojson: "data/geojson/Chef_lieu_departement/chef_lieu_departement.geojson",
        toggleId: "t_cld",
        defaultVisible: true
      },
      {
        key: "Chef_lieu_district",
        label: "Chefs-lieux de districts",
        geojson: "data/geojson/Chef_lieu_district/chef_lieu_district.geojson",
        toggleId: "t_cldist",
        defaultVisible: true
      },
      {
        key: "Reseau_routier_structurant",
        label: "Réseau routier structurant",
        geojson: "data/geojson/Reseau_routier_structurant/reseau_routier_structurant.geojson",
        toggleId: "t_routes",
        defaultVisible: false
      },
      {
        key: "Limites_departements_congo",
        label: "Limites des départements",
        geojson: "data/geojson/Limites_departements_congo/limites_departements_congo.geojson",
        toggleId: "t_dep",
        defaultVisible: true
      }
    ];

    const map = L.map("map", { zoomControl: true }).setView([-1.0, 15.3], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const elStatusText = document.getElementById("statusText");
    const elStatusDot = document.getElementById("statusDot");
    const elLevelDesktop = document.getElementById("level");
    const elLevelMobile = document.getElementById("level_m"); // (non utilisé en mobile ici)

    const panelMobile = document.getElementById("panelMobile");
    const overlay = document.getElementById("overlay");
    const openPanelBtn = document.getElementById("openPanelBtn");
    const closePanelBtn = document.getElementById("closePanelBtn");

    let layersByKey = {};
    let boundsAll = null;

    function setStatus(ok, fail){
      if(fail === 0 && ok > 0){
        elStatusDot.className = "dot ok";
        elStatusText.textContent = `OK ${ok} couche(s)`;
      } else if(ok === 0){
        elStatusDot.className = "dot bad";
        elStatusText.textContent = `OK 0 • ⚠️ ${fail} manquant(s)`;
      } else {
        elStatusDot.className = "dot";
        elStatusText.textContent = `OK ${ok} • ⚠️ ${fail} manquant(s)`;
      }
    }

    function getPointName(props){
      const v = props?.Nom;
      const s = (v ?? "").toString().trim();
      return s ? s : "Sans nom";
    }

    function getDepartementName(props){
      const candidates = ["Departement","DEPARTEMENT","département","NOM","Nom","nom","NAME","Name"];
      for(const k of candidates){
        const v = props?.[k];
        const s = (v ?? "").toString().trim();
        if(s) return s;
      }
      for(const [k,v] of Object.entries(props || {})){
        const s = (v ?? "").toString().trim();
        if(!s) continue;
        if(/^\d+(\.\d+)?$/.test(s)) continue;
        if(s.length <= 80) return s;
      }
      return "Sans nom";
    }

    function styleByKey(key){
      if(key === "Limites_departements_congo"){
        return { color: "#000000", weight: 2, fillOpacity: 0.03 };
      }
      if(key === "Reseau_routier_structurant"){
        return { color: "#ef4444", weight: 2, opacity: 0.9 };
      }
      return { color: "#f59e0b", weight: 2, opacity: 0.9 };
    }

    const redPinIcon = L.divIcon({
      className: "",
      iconSize: [18, 18],
      iconAnchor: [9, 18],
      html: `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 22s7-6.2 7-13a7 7 0 1 0-14 0c0 6.8 7 13 7 13z" fill="#ef4444"/>
          <circle cx="12" cy="9" r="2.6" fill="#0b1220"/>
        </svg>
      `
    });

    function pointToLayerByKey(dsKey, feature, latlng){
      if(dsKey === "Chef_lieu_departement" || dsKey === "Chef_lieu_district"){
        return L.marker(latlng, { icon: redPinIcon });
      }
      return L.circleMarker(latlng, { radius: 6, color: "#0b1220", weight: 1, fillColor: "#f59e0b", fillOpacity: 0.95 });
    }

    function fmtNum(x){
      if(x === null || x === undefined || x === "") return "-";
      const n = Number(String(x).replace(",", "."));
      if(Number.isNaN(n)) return String(x);
      return n.toLocaleString("fr-FR");
    }

    function popupDepartement(props){
      const dep = getDepartementName(props);
      const superficie = props?.["Superficie (km2)"] ?? props?.["Superficie"] ?? props?.Superficie ?? props?.SUPERFICIE;
      const densite = props?.["Densité"] ?? props?.Densite ?? props?.DENSITE ?? props?.densite ?? props?.dens ?? props?.density;
      const population = props?.["Population"] ?? props?.Population ?? props?.POPULATION ?? props?.pop ?? props?.Pop;

      return `
        <div style="font-family:Arial; min-width:260px">
          <div style="font-weight:900; font-size:14px; margin-bottom:8px">${dep}</div>
          <table style="width:100%; border-collapse:collapse; font-size:12px">
            <tr>
              <td style="padding:4px 0; color:#666">Superficie (km2)</td>
              <td style="padding:4px 0; text-align:right"><b>${fmtNum(superficie)}</b></td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#666">Population (RGPH-5, 2023)</td>
              <td style="padding:4px 0; text-align:right"><b>${fmtNum(population)}</b></td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#666">Densité de population (hab/km2)</td>
              <td style="padding:4px 0; text-align:right"><b>${fmtNum(densite)}</b></td>
            </tr>
          </table>
        </div>
      `;
    }

    async function loadDataset(ds){
      const res = await fetch(ds.geojson);
      if(!res.ok) throw new Error(`Non chargé: ${ds.geojson}`);
      const gj = await res.json();

      const layer = L.geoJSON(gj, {
        style: () => styleByKey(ds.key),
        pointToLayer: (feature, latlng) => pointToLayerByKey(ds.key, feature, latlng),
        onEachFeature: (feature, l) => {
          const props = feature.properties || {};

          if(ds.key === "Limites_departements_congo"){
            l.bindPopup(popupDepartement(props));
          } else if(ds.key === "Chef_lieu_departement" || ds.key === "Chef_lieu_district"){
            const name = getPointName(props);
            l.bindPopup(`<b>${name}</b><br><span style="font-size:12px;color:#666">${ds.label}</span>`);
          } else {
            const name = getDepartementName(props);
            l.bindPopup(`<b>${name}</b><br><span style="font-size:12px;color:#666">${ds.label}</span>`);
          }

          if(ds.key === "Chef_lieu_departement"){
            const name = getPointName(props);
            l.bindTooltip(name, {
              permanent: true,
              direction: "top",
              offset: [0, -10],
              opacity: 0.95,
              className: "lbl"
            });
          }
        }
      });

      layersByKey[ds.key] = layer;

      const b = layer.getBounds();
      if(b.isValid()) boundsAll = boundsAll ? boundsAll.extend(b) : b;

      return layer;
    }

    /* ✅ ordre demandé aussi pour la synchro (checkbox -> couche) */
    const toggleMap = [
      { dsKey: "Chef_lieu_departement",      d: "t_cld" },
      { dsKey: "Chef_lieu_district",         d: "t_cldist" },
      { dsKey: "Reseau_routier_structurant", d: "t_routes" },
      { dsKey: "Limites_departements_congo", d: "t_dep" }
    ];

    function syncVisibility(){
      for(const t of toggleMap){
        const cb = document.getElementById(t.d);
        const layer = layersByKey[t.dsKey];
        if(!layer || !cb) continue;

        const on = cb.checked;
        const has = map.hasLayer(layer);
        if(on && !has) layer.addTo(map);
        if(!on && has) map.removeLayer(layer);
      }
    }

    function bindToggleSync(){
      for(const t of toggleMap){
        const d = document.getElementById(t.d);
        if(d){
          d.addEventListener("change", () => {
            syncVisibility();
          });
        }
      }
    }

    function moveDownloadsOnMobile(){
      const downloads = document.getElementById("downloads");
      const desktopAside = document.getElementById("desktopAside");
      const slot = document.getElementById("downloadsMobileSlot");
      if(!downloads || !desktopAside || !slot) return;

      let anchor = document.getElementById("downloadsAnchor");
      if(!anchor){
        anchor = document.createElement("div");
        anchor.id = "downloadsAnchor";
        downloads.parentNode.insertBefore(anchor, downloads);
      }

      const isMobile = window.matchMedia("(max-width: 900px)").matches;
      if(isMobile){
        if(downloads.parentNode !== slot) slot.appendChild(downloads);
      }else{
        if(downloads.parentNode !== desktopAside){
          anchor.parentNode.insertBefore(downloads, anchor.nextSibling);
        }
      }
    }

    function moveLayersCardOnMobile(){
      const layersCard = document.getElementById("layersCard");
      const desktopAside = document.getElementById("desktopAside");
      const slot = document.getElementById("mobileControlsSlot");
      if(!layersCard || !desktopAside || !slot) return;

      let anchor = document.getElementById("layersAnchor");
      if(!anchor){
        anchor = document.createElement("div");
        anchor.id = "layersAnchor";
        layersCard.parentNode.insertBefore(anchor, layersCard);
      }

      const isMobile = window.matchMedia("(max-width: 900px)").matches;
      if(isMobile){
        if(layersCard.parentNode !== slot) slot.appendChild(layersCard);
      }else{
        if(layersCard.parentNode !== desktopAside){
          anchor.parentNode.insertBefore(layersCard, anchor.nextSibling);
        }
      }
    }

    (async function init(){
      setStatus(0, DATASETS.length);

      let ok = 0, fail = 0;
      for(const ds of DATASETS){
        try{ await loadDataset(ds); ok++; }
        catch(e){ console.error(e); fail++; }
      }

      for(const ds of DATASETS){
        const isOn = !!ds.defaultVisible;
        const mapItem = toggleMap.find(x => x.dsKey === ds.key);
        if(mapItem){
          const cb = document.getElementById(mapItem.d);
          if(cb) cb.checked = isOn;
        }
      }
      syncVisibility();

      if(boundsAll?.isValid()) map.fitBounds(boundsAll, {padding:[20,20]});

      bindToggleSync();

      setStatus(ok, fail);

      moveLayersCardOnMobile();
      moveDownloadsOnMobile();

      setTimeout(() => map.invalidateSize(true), 50);

      window.addEventListener("resize", () => {
        moveLayersCardOnMobile();
        moveDownloadsOnMobile();
        map.invalidateSize();
      });
      window.addEventListener("orientationchange", () => {
        setTimeout(() => {
          moveLayersCardOnMobile();
          moveDownloadsOnMobile();
          map.invalidateSize();
        }, 250);
      });
    })();
  </script>
</body>
</html>
